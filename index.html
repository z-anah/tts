<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Lessons CRUD</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    html,
    body,
    #app {
      height: 100%;
    }

    body {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 48;
    }
  </style>
</head>

<body class="bg-gradient-to-b from-indigo-50 to-cyan-50">

  <div id="app" class="min-h-screen flex flex-col">

    <header class="bg-white shadow p-4 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <span class="material-symbols-outlined text-indigo-600 text-3xl">school</span>
      </div>
      <nav class="flex gap-3">
        <button @click="view='list'" :class="navClass('list')" title="List Lessons">
          <span class="material-symbols-outlined">list</span>
        </button>
        <button @click="view='create'" :class="navClass('create')" title="Create Lesson">
          <span class="material-symbols-outlined">add</span>
        </button>
        <button @click="view='detail'" :class="navClass('detail')" v-if="currentLesson" title="View Detail">
          <span class="material-symbols-outlined">visibility</span>
        </button>
        <button @click="view='about'" :class="navClass('about')" title="About">
          <span class="material-symbols-outlined">info</span>
        </button>
      </nav>
    </header>

    <main class="flex-1 p-2">

      <section v-if="view==='list'" class="max-w-5xl mx-auto">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">All Lessons</h2>
          <button @click="fetchLessons" class="p-2 rounded hover:bg-indigo-100">
            <span class="material-symbols-outlined">refresh</span>
          </button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <div v-for="l in lessons" :key="l.id" class="p-4 bg-white rounded-xl shadow">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-bold">{{ l.title }}</h3>
                <p class="text-xs text-gray-500">ID: {{ l.id }}</p>
              </div>
              <div class="flex gap-2">
                <button @click="copyLesson(l)" class="p-1 rounded hover:bg-slate-100" title="Copy">
                  <span class="material-symbols-outlined">content_copy</span>
                </button>
                <button @click="viewDetail(l)" class="p-1 rounded hover:bg-slate-100">
                  <span class="material-symbols-outlined">visibility</span>
                </button>
                <button @click="removeLesson(l.id)" class="p-1 rounded hover:bg-slate-100">
                  <span class="material-symbols-outlined">delete</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div v-if="!lessons.length" class="text-center text-gray-500 mt-10">No lessons yet.</div>
        <div class="mt-6 flex justify-center">
          <button @click="seedIfEmpty"
            class="px-4 py-2 bg-indigo-600 text-white rounded hover:opacity-90 flex items-center gap-2" title="Add Sample Data">
            <span class="material-symbols-outlined">bolt</span>
          </button>
        </div>
      </section>

      <section v-if="view==='create'" class="max-w-lg mx-auto bg-white rounded-xl shadow p-2">
        <h2 class="text-lg font-semibold mb-4">{{ editing ? 'Edit Lesson' : 'Create Lesson' }}</h2>
        <form @submit.prevent="editing ? updateLesson() : createLesson()" class="space-y-4">
          <div>
            <label class="block text-sm text-gray-600 mb-1">Title</label>
            <input v-model="form.title" class="w-full border rounded px-3 py-2 text-sm" placeholder="Lesson title">
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Content</label>
            <textarea v-model="form.content" rows="6" class="w-full border rounded px-3 py-2 text-sm"
              placeholder="Write content here"></textarea>
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" @click="cancel" class="px-4 py-2 rounded border">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:opacity-90">Save</button>
          </div>
        </form>
      </section>

      <section v-if="view==='about'" class="max-w-2xl mx-auto text-center mt-10">
        <span class="material-symbols-outlined text-6xl text-indigo-400 mb-4">emoji_objects</span>
        <h2 class="text-2xl font-bold mb-2">About This App</h2>
        <p class="text-gray-600 leading-relaxed">
          A minimal learning CRUD app built with Vue 3 (CDN), Tailwind CSS, and Supabase.<br>
          Manage Arabic and English lesson pairs easily — create, view, update, delete.
        </p>
      </section>

      <section v-if="view==='detail'" class="max-w-3xl mx-auto">
        <div class="bg-white rounded-xl shadow p-2" v-if="currentLesson">
          <div class="flex justify-between items-start mb-6">
            <div>
              <h2 class="text-2xl font-bold text-slate-800">{{ currentLesson.title }}</h2>
              <p class="text-sm text-gray-500">Lesson ID: {{ currentLesson.id }}</p>
            </div>
            <div class="flex gap-2">
              <button @click="startEdit(currentLesson)" class="p-2 rounded hover:bg-slate-100">
                <span class="material-symbols-outlined">edit</span>
              </button>
              <button @click="view='list'" class="p-2 rounded hover:bg-slate-100">
                <span class="material-symbols-outlined">arrow_back</span>
              </button>
            </div>
          </div>
          <div class="prose max-w-none">
            <div v-for="(line, index) in contentLines" :key="index" class="mb-4">
              <canvas v-if="(index + 1) % 2 === 0" 
                      :ref="'canvas-' + index" 
                      class="border rounded bg-gray-50 w-full"
                      style="height: 60px;">
              </canvas>
              <div v-else class="text-gray-700 leading-relaxed text-3xl text-right" dir="rtl">{{ line }}</div>
            </div>
          </div>
        </div>
        <div v-else class="text-center text-gray-500 mt-10">No lesson selected.</div>
      </section>

    </main>

  </div>

  <script>
    const { createClient } = supabase;
      const SUPABASE_URL = "https://igjyzsigahdoqrcsxjrt.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlnanl6c2lnYWhkb3FyY3N4anJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjAyOTUsImV4cCI6MjA3NTk5NjI5NX0.8O3RlI01KdilSsKPvCGHSlFspttiFeYmWKU2-r60P7w";
      const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    Vue.createApp({
      data() {
        return {
          view: 'list',
          lessons: [],
          form: { id: null, title: '', content: '' },
          editing: false,
          currentLesson: null
        }
      },
      mounted() { this.fetchLessons() },
      methods: {
        navClass(v) { return 'p-2 rounded ' + (this.view === v ? 'bg-indigo-100 text-indigo-600' : 'hover:bg-indigo-50'); },
        async fetchLessons() {
          const { data } = await supabaseClient.from('lessons').select('*').order('id', { ascending: true });
          this.lessons = data || [];
        },
        async createLesson() {
          if (!this.form.title.trim() || !this.form.content.trim()) return;
          const { data } = await supabaseClient.from('lessons').insert([{
            title: this.form.title.trim(),
            content: this.form.content.trim()
          }]).select().single();
          if (data) this.lessons.push(data);
          this.cancel(); this.view = 'list';
        },
        copyLesson(lesson) {
          const textToCopy = `${lesson.title}\n\n${lesson.content}`;
          navigator.clipboard.writeText(textToCopy).then(() => {
            // Optional: Show a brief success indication
            console.log('Lesson copied to clipboard');
          }).catch(err => {
            console.error('Failed to copy: ', err);
          });
        },
        viewDetail(lesson) { 
          this.currentLesson = lesson; 
          this.view = 'detail'; 
        },
        renderCanvasLines() {
          this.contentLines.forEach((line, index) => {
            if ((index + 1) % 2 === 0) {
              const canvas = this.$refs['canvas-' + index]?.[0];
              if (canvas) {
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = 60;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '10px Inter, sans-serif';
                ctx.fillStyle = '#22c55e';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                ctx.fillText(line, canvas.width / 2, canvas.height / 2);
              }
            }
          });
        },
        startEdit(l) { this.form = { ...l }; this.editing = true; this.view = 'create'; },
        async updateLesson() {
          const { data } = await supabaseClient.from('lessons').update({
            title: this.form.title.trim(),
            content: this.form.content.trim()
          }).eq('id', this.form.id).select().single();
          if (data) {
            const i = this.lessons.findIndex(x => x.id === data.id);
            if (i >= 0) this.lessons.splice(i, 1, data);
          }
          this.cancel(); this.view = 'list';
        },
        async removeLesson(id) {
          await supabaseClient.from('lessons').delete().eq('id', id);
          this.lessons = this.lessons.filter(x => x.id !== id);
        },
        cancel() { this.editing = false; this.form = { id: null, title: '', content: '' }; this.view = 'list'; },
        async seedIfEmpty() {
          if (this.lessons.length) return;
          const sample = [{
            title: 'Basic Greetings', content: `السَّلامُ عَلَيْكُم
Hello
كَيْفَ حَالُكَ؟
How are you?
شُكْرًا جَزِيلًا
Thank you very much
مَعَ السَّلَامَة
Goodbye`}];
          await supabaseClient.from('lessons').insert(sample);
          this.fetchLessons();
        }
      },
      computed: {
        contentLines() {
          return this.currentLesson ? this.currentLesson.content.split('\n').filter(line => line.trim()) : [];
        }
      },
      watch: {
        currentLesson() {
          if (this.currentLesson) {
            this.$nextTick(() => {
              this.renderCanvasLines();
            });
          }
        }
      }
    }).mount('#app');
  </script>

</body>

</html>
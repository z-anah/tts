<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Lessons CRUD</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'media'
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    html,
    body,
    #app {
      height: 100%;
    }

    body {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 48;
    }
  </style>
</head>

<body class="bg-gradient-to-b from-indigo-50 to-cyan-50 dark:from-gray-900 dark:to-gray-800">

  <div id="app" class="min-h-screen flex flex-col">

    <header class="bg-white dark:bg-gray-800 shadow p-4 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <span class="material-symbols-outlined text-indigo-600 dark:text-indigo-400 text-3xl">school</span>
      </div>
      <nav class="flex gap-3">
        <button @click="view='list'" :class="navClass('list')" title="List Lessons">
          <span class="material-symbols-outlined">list</span>
        </button>
        <button @click="view='create'" :class="navClass('create')" title="Create Lesson">
          <span class="material-symbols-outlined">add</span>
        </button>
        <button @click="view='detail'" :class="navClass('detail')" v-if="currentLesson" title="View Detail">
          <span class="material-symbols-outlined">visibility</span>
        </button>
        <button @click="view='prelearn'" :class="navClass('prelearn')" title="Pre-Learning">
          <span class="material-symbols-outlined">priority_high</span>
        </button>
      </nav>
    </header>

    <main class="flex-1 p-2">

      <section v-if="view==='list'" class="max-w-5xl mx-auto">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold dark:text-white">All Lessons</h2>
          <div class="flex gap-2">
            <button @click="fetchLessons" class="p-2 rounded hover:bg-indigo-100 dark:hover:bg-gray-700">
              <span class="material-symbols-outlined dark:text-white">refresh</span>
            </button>
            <button @click="navigateToIndex" class="p-2 rounded hover:bg-indigo-100 dark:hover:bg-gray-700">
              <span class="material-symbols-outlined dark:text-white">arrow_back</span>
            </button>
          </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <div v-for="l in lessons" :key="l.id" 
               @click="viewDetail(l)"
               class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow cursor-pointer hover:shadow-lg transition-shadow">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-bold dark:text-white">{{ l.title }}</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400">ID: {{ l.id }}</p>
              </div>
              <div class="flex gap-2">
                <button @click.stop="copyLesson(l)" class="p-1 rounded hover:bg-slate-100 dark:hover:bg-gray-700" title="Copy">
                  <span class="material-symbols-outlined dark:text-white">content_copy</span>
                </button>
                <button @click.stop="viewDetail(l)" class="p-1 rounded hover:bg-slate-100 dark:hover:bg-gray-700">
                  <span class="material-symbols-outlined dark:text-white">visibility</span>
                </button>
                <button @click.stop="removeLesson(l.id)" class="p-1 rounded hover:bg-slate-100 dark:hover:bg-gray-700">
                  <span class="material-symbols-outlined dark:text-white">delete</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div v-if="!lessons.length" class="text-center text-gray-500 dark:text-gray-400 mt-10">No lessons yet.</div>
      </section>

      <section v-if="view==='create'" class="max-w-lg mx-auto bg-white dark:bg-gray-800 rounded-xl shadow p-2">
        <h2 class="text-lg font-semibold mb-4 dark:text-white">{{ editing ? 'Edit Lesson' : 'Create Lesson' }}</h2>
        <form @submit.prevent="editing ? updateLesson() : createLesson()" class="space-y-4">
          <div>
            <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">Title</label>
            <input v-model="form.title" class="w-full border dark:border-gray-600 rounded px-3 py-2 text-sm bg-white dark:bg-gray-700 dark:text-white" placeholder="Lesson title">
          </div>
          <div>
            <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">Content</label>
            <textarea v-model="form.content" rows="6" class="w-full border dark:border-gray-600 rounded px-3 py-2 text-sm bg-white dark:bg-gray-700 dark:text-white"
              placeholder="Write content here"></textarea>
          </div>
          <div>
            <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">Text Direction</label>
            <select v-model="form.direction" class="w-full border dark:border-gray-600 rounded px-3 py-2 text-sm bg-white dark:bg-gray-700 dark:text-white">
              <option value="rtl">Right-to-Left (RTL)</option>
              <option value="ltr">Left-to-Right (LTR)</option>
            </select>
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" @click="cancel" class="px-4 py-2 rounded border dark:border-gray-600 dark:text-white dark:hover:bg-gray-700">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-indigo-600 dark:bg-indigo-700 text-white rounded hover:opacity-90">Save</button>
          </div>
        </form>
      </section>

      <section v-if="view==='detail'" class="max-w-3xl mx-auto">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-2" v-if="currentLesson">
          <div class="flex justify-between items-start mb-6">
            <div>
              <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">{{ currentLesson.title }}</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400">Lesson ID: {{ currentLesson.id }}</p>
            </div>
            <div class="flex gap-2">
              <button @click="toggleDirection" class="p-2 rounded hover:bg-slate-100 dark:hover:bg-gray-700" title="Toggle Direction">
                <span class="material-symbols-outlined dark:text-white">{{ currentLesson.direction === 'rtl' ? 'format_textdirection_r_to_l' : 'format_textdirection_l_to_r' }}</span>
              </button>
              <button @click="startEdit(currentLesson)" class="p-2 rounded hover:bg-slate-100 dark:hover:bg-gray-700">
                <span class="material-symbols-outlined dark:text-white">edit</span>
              </button>
              <button @click="view='list'" class="p-2 rounded hover:bg-slate-100 dark:hover:bg-gray-700">
                <span class="material-symbols-outlined dark:text-white">arrow_back</span>
              </button>
            </div>
          </div>
          <div class="prose max-w-none">
            <div v-for="(line, index) in contentLines" :key="index" class="mb-4">
              <canvas v-if="(index + 1) % 2 === 0" :ref="'canvas-' + index" class="border dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 w-full"
                style="height: 60px;">
              </canvas>
              <div v-else class="text-gray-700 dark:text-gray-300 leading-relaxed text-3xl" 
                   :class="currentLesson.direction === 'rtl' ? 'text-right' : 'text-left'" 
                   :dir="currentLesson.direction">{{ line }}</div>
            </div>
          </div>
        </div>
        <div v-else class="text-center text-gray-500 dark:text-gray-400 mt-10">No lesson selected.</div>
      </section>

      <section v-if="view==='fullscreen'" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex flex-col">
        
        <div class="flex-1 overflow-auto p-8" v-if="currentLesson">
          <button @click="view='detail'" class="p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="Exit Fullscreen">
            <span class="material-symbols-outlined dark:text-white">fullscreen_exit</span>
          </button>
          <div class="max-w-4xl mx-auto">
            <div v-for="(line, index) in contentLines" :key="index" class="mb-8">
              <canvas v-if="(index + 1) % 2 === 0" :ref="'fullscreen-canvas-' + index" 
                class="border dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-800 w-full" style="height: 80px;">
              </canvas>
              <div v-else class="text-gray-800 dark:text-gray-200 leading-relaxed text-4xl p-4" 
                   :class="currentLesson.direction === 'rtl' ? 'text-right' : 'text-left'" 
                   :dir="currentLesson.direction">{{ line }}</div>
            </div>
          </div>
        </div>
      </section>

      <section v-if="view==='prelearn'" class="max-w-3xl mx-auto">
        <div class="bg-white dark:bg-gray-800 rounded-lg border dark:border-gray-700 p-8">
          <div class="text-center mb-8">
            <span class="material-symbols-outlined text-5xl text-red-500 dark:text-red-400 mb-4">warning</span>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Essential Reading</h2>
            <p class="text-gray-600 dark:text-gray-400">Before you begin your Arabic journey</p>
          </div>
          
          <div class="space-y-6 text-gray-800 dark:text-gray-200 leading-relaxed">
            <div v-for="(paragraph, index) in preLearningText" :key="index" class="text-lg">
              {{ paragraph }}
            </div>
          </div>
          
          <div class="mt-8 p-4 bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 rounded-r">
            <p class="text-red-800 dark:text-red-200 font-semibold text-center">
              This is not optional. This is your responsibility.
            </p>
          </div>
          
          <div class="mt-8 text-center">
            <button @click="view='list'" class="px-6 py-3 bg-red-600 dark:bg-red-700 text-white rounded-lg hover:bg-red-700 dark:hover:bg-red-600 font-semibold">
              I Understand - Begin Learning
            </button>
          </div>
        </div>
      </section>

    </main>

  </div>

  <script>
    const { createClient } = supabase;
    const SUPABASE_URL = "https://igjyzsigahdoqrcsxjrt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlnanl6c2lnYWhkb3FyY3N4anJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjAyOTUsImV4cCI6MjA3NTk5NjI5NX0.8O3RlI01KdilSsKPvCGHSlFspttiFeYmWKU2-r60P7w";
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    Vue.createApp({
      data() {
        return {
          view: 'list',
          lessons: [],
          form: { id: null, title: '', content: '', direction: 'rtl' },
          editing: false,
          currentLesson: null,
          preLearningText: [
            "Arabic is not just another language to learn for personal enrichment or career advancement. It is the language of the Quran, the final revelation from Allah to humanity.",
            "Every Muslim has a fundamental obligation to understand the words of Allah in their original form. Learning Arabic is not merely recommended - it is a duty that connects you directly to your faith.",
            "The Prophet Muhammad (peace be upon him) said: 'Love Arabic for three reasons: because I am Arab, because the Quran is in Arabic, and because the language of Paradise is Arabic.'",
            "When you learn Arabic, you are not just acquiring vocabulary and grammar. You are unlocking the ability to understand Allah's direct words, without the barrier of translation.",
            "Every moment you delay learning Arabic is a moment you remain distant from the true meaning of your prayers, your Quran recitation, and your connection with Allah.",
            "This is your Islamic duty. This is your spiritual responsibility. This is your path to deeper faith and understanding.",
            "Begin now. Allah is watching, and your effort in learning His language will be rewarded both in this life and the hereafter."
          ]
        }
      },
      mounted() { 
        this.fetchLessons().then(() => {
          this.restoreViewState();
        });
      },
      methods: {
        navClass(v) { return 'p-2 rounded ' + (this.view === v ? 'bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-400' : 'hover:bg-indigo-50 dark:hover:bg-gray-700 dark:text-white'); },
        async fetchLessons() {
          const { data } = await supabaseClient.from('lessons').select('*').order('id', { ascending: true });
          this.lessons = data || [];
        },
        async createLesson() {
          if (!this.form.title.trim() || !this.form.content.trim()) return;
          const { data } = await supabaseClient.from('lessons').insert([{
            title: this.form.title.trim(),
            content: this.form.content.trim(),
            direction: this.form.direction
          }]).select().single();
          if (data) this.lessons.push(data);
          this.cancel(); this.view = 'list';
        },
        copyLesson(lesson) {
          const textToCopy = `${lesson.title}\n\n${lesson.content}`;
          navigator.clipboard.writeText(textToCopy).then(() => {
            // Optional: Show a brief success indication
            console.log('Lesson copied to clipboard');
          }).catch(err => {
            console.error('Failed to copy: ', err);
          });
        },
        viewDetail(lesson) {
          this.currentLesson = lesson;
          this.view = 'detail';
          this.saveViewState();
        },
        renderCanvasLines() {
          this.contentLines.forEach((line, index) => {
            if ((index + 1) % 2 === 0) {
              // Regular detail view canvas
              const canvas = this.$refs['canvas-' + index]?.[0];
              if (canvas) {
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = 60;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '10px Inter, sans-serif';
                // Check for dark mode
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                ctx.fillStyle = isDark ? '#4ade80' : '#22c55e';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                ctx.fillText(line, canvas.width / 2, canvas.height / 2);
              }

              // Fullscreen view canvas
              const fullscreenCanvas = this.$refs['fullscreen-canvas-' + index]?.[0];
              if (fullscreenCanvas) {
                const ctx = fullscreenCanvas.getContext('2d');
                fullscreenCanvas.width = fullscreenCanvas.offsetWidth;
                fullscreenCanvas.height = 80;

                ctx.clearRect(0, 0, fullscreenCanvas.width, fullscreenCanvas.height);
                ctx.font = '16px Inter, sans-serif';
                // Check for dark mode
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                ctx.fillStyle = isDark ? '#4ade80' : '#22c55e';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                ctx.fillText(line, fullscreenCanvas.width / 2, fullscreenCanvas.height / 2);
              }
            }
          });
        },
        startEdit(l) { 
          this.form = { ...l }; 
          this.editing = true; 
          this.view = 'create';
          this.saveViewState();
        },
        async updateLesson() {
          const { data } = await supabaseClient.from('lessons').update({
            title: this.form.title.trim(),
            content: this.form.content.trim(),
            direction: this.form.direction
          }).eq('id', this.form.id).select().single();
          if (data) {
            const i = this.lessons.findIndex(x => x.id === data.id);
            if (i >= 0) this.lessons.splice(i, 1, data);
          }
          this.cancel(); this.view = 'list';
        },
        async removeLesson(id) {
          await supabaseClient.from('lessons').delete().eq('id', id);
          this.lessons = this.lessons.filter(x => x.id !== id);
        },
        async toggleDirection() {
          if (!this.currentLesson) return;
          const newDirection = this.currentLesson.direction === 'rtl' ? 'ltr' : 'rtl';
          const { data } = await supabaseClient.from('lessons').update({
            direction: newDirection
          }).eq('id', this.currentLesson.id).select().single();
          
          if (data) {
            this.currentLesson.direction = newDirection;
            const i = this.lessons.findIndex(x => x.id === data.id);
            if (i >= 0) this.lessons.splice(i, 1, data);
          }
        },
        cancel() { 
          this.editing = false; 
          this.form = { id: null, title: '', content: '', direction: 'rtl' }; 
          this.view = 'list';
          this.saveViewState();
        },
        saveViewState() {
          const state = {
            view: this.view,
            currentLessonId: this.currentLesson?.id || null,
            editing: this.editing,
            formId: this.form.id
          };
          localStorage.setItem('vocab-view-state', JSON.stringify(state));
        },
        restoreViewState() {
          try {
            const savedState = localStorage.getItem('vocab-view-state');
            if (savedState) {
              const state = JSON.parse(savedState);
              
              if (state.currentLessonId) {
                const lesson = this.lessons.find(l => l.id === state.currentLessonId);
                if (lesson) {
                  this.currentLesson = lesson;
                }
              }
              
              if (state.editing && state.formId) {
                const lesson = this.lessons.find(l => l.id === state.formId);
                if (lesson) {
                  this.startEdit(lesson);
                  return; // startEdit already sets the view
                }
              }
              
              this.view = state.view || 'list';
            }
          } catch (error) {
            console.error('Error restoring view state:', error);
          }
        },
        navigateToIndex() {
          window.location.href = 'index.html';
        }
      },
      computed: {
        contentLines() {
          return this.currentLesson ? this.currentLesson.content.split('\n').filter(line => line.trim()) : [];
        }
      },
      watch: {
        currentLesson() {
          if (this.currentLesson) {
            this.$nextTick(() => {
              this.renderCanvasLines();
            });
          }
        },
        view() {
          this.saveViewState();
          if (this.view === 'fullscreen' && this.currentLesson) {
            this.$nextTick(() => {
              this.renderCanvasLines();
            });
          }
        }
      }
    }).mount('#app');
  </script>

</body>

</html>